{% extends "user_base.html" %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-12">
        <h2 class="text-primary">My Booking History</h2>
    </div>
</div>

{% if reservations %}
    <!-- Active Bookings -->
    {% set active_reservations = reservations | selectattr('leaving_timestamp', 'none') | list %}
    {% if active_reservations %}
        <div class="card mb-4">
            <div class="card-header bg-warning">
                <h5 class="mb-0">Active Bookings</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-bordered mb-0">
                        <thead>
                            <tr>
                                <th>Booking ID</th>
                                <th>Spot ID</th>
                                <th>Location</th>
                                <th>Vehicle</th>
                                <th>Check-in Time</th>
                                <th>Rate</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for reservation in active_reservations %}
                            <tr>
                                <td>#{{ reservation.id }}</td>
                                <td>{{ reservation.spot_id }}</td>
                                <td>{{ reservation.spot.lot.prime_location_name }}</td>
                                <td>
                                    <strong>{{ reservation.vehicle_number }}</strong><br>
                                    <small class="text-muted">{{ reservation.vehicle_type }}</small>
                                </td>
                                <td>{{ reservation.parking_timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>₹{{ reservation.parking_cost_per_unit }}/hr</td>
                                <td>
                                    <form action="{{ url_for('release_spot') }}" method="post" style="display:inline;">
                                        <input type="hidden" name="reservation_id" value="{{ reservation.id }}">
                                        <button type="submit" class="btn btn-danger btn-sm" onclick="return confirm('Release this spot?');">Release Spot</button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}
    
    <!-- Booking History -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">Complete Booking History</h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Spot</th>
                            <th>Location</th>
                            <th>Vehicle</th>
                            <th>Check-in</th>
                            <th>Check-out</th>
                            <th>Duration</th>
                            <th>Cost</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for reservation in reservations %}
                        <tr>
                            <td>#{{ reservation.id }}</td>
                            <td>{{ reservation.spot_id }}</td>
                            <td>
                                {% if reservation.spot and reservation.spot.lot %}
                                    {{ reservation.spot.lot.prime_location_name }}
                                {% else %}
                                    <span class="text-muted">(Deleted Location)</span>
                                {% endif %}
                            </td>
                            <td>
                                <strong>{{ reservation.vehicle_number }}</strong><br>
                                <small class="text-muted">{{ reservation.vehicle_type }}</small>
                            </td>
                            <td>{{ reservation.parking_timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>
                                {% if reservation.leaving_timestamp %}
                                    {{ reservation.leaving_timestamp.strftime('%Y-%m-%d %H:%M') }}
                                {% else %}
                                    <span class="badge bg-warning">Ongoing</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if reservation.leaving_timestamp %}
                                    {% set duration = (reservation.leaving_timestamp - reservation.parking_timestamp).total_seconds() / 3600 %}
                                    {{ "%.2f"|format(duration) }} hrs
                                {% else %}
                                    -
                                {% endif %}
                            </td>
                            <td>
                                {% if reservation.leaving_timestamp %}
                                    {% set duration = (reservation.leaving_timestamp - reservation.parking_timestamp).total_seconds() / 3600 %}
                                    ₹{{ "%.2f"|format(duration * reservation.parking_cost_per_unit) }}
                                {% else %}
                                    Ongoing
                                {% endif %}
                            </td>
                            <td>
                                {% if reservation.leaving_timestamp %}
                                    <span class="badge bg-success">Completed</span>
                                {% else %}
                                    <span class="badge bg-warning">Active</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% else %}
    <div class="alert alert-info">
        <h5>No Bookings Yet</h5>
        <p class="mb-0">You haven't made any parking reservations. <a href="{{ url_for('user', id=session['user_id']) }}" class="alert-link">Find a parking spot</a></p>
    </div>
{% endif %}
{% endblock %}